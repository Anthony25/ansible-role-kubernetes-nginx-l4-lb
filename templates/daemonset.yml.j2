apiVersion: apps/v1beta2
kind: DaemonSet
metadata:
  name: {{ kubernetes_nginx_l4_lb_deployment }}
  namespace: {{ kubernetes_nginx_l4_lb_namespace }}
  labels:
    app: {{ kubernetes_nginx_l4_lb_app }}
{% if kubernetes_nginx_l4_lb_deployment_labels %}
    {{ kubernetes_nginx_l4_lb_deployment_labels | to_nice_yaml | indent(4) }}
{% endif %}
{% if kubernetes_nginx_l4_lb_deployment_annotations %}
  annotations:
    {{ kubernetes_nginx_l4_lb_deployment_annotations | to_nice_yaml | indent(4) }}
{% endif %}
spec:
  selector:
    matchLabels:
      app: {{ kubernetes_nginx_l4_lb_app }}
  template:
    metadata:
      labels:
        app: {{ kubernetes_nginx_l4_lb_app }}
    spec:
      hostNetwork: true
      containers:
      - image: {{ kubernetes_nginx_l4_lb_image }}
        imagePullPolicy: Always
        name: nginx_l4_lb
        resources:
          {{ kubernetes_nginx_l4_lb_resources | to_yaml | indent(10) }}
        securityContext:
          capabilities:
          drop:
            - ALL
          add:
            - NET_BIND_SERVICE
          # runAsUser: 0
          privileged: true

        volumeMounts:
          - mountPath: /etc/nginx/conf.d/streams.conf
            name: {{ kubernetes_nginx_l4_lb_configmap }}
            subPath: streams.conf

{% if kubernetes_nginx_l4_lb_node_selector|default({}) %}
      nodeSelector: {{ kubernetes_nginx_l4_lb_node_selector | to_yaml }}
{% endif %}
      restartPolicy: Always
status: {}
